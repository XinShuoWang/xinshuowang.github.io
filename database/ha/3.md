# CAP定理
- C：Consistency，一致性，指的是每个读操作都能收到一个最近写入的值或者错误。
- A：Availability，可用性，指的是每个读写request都可以得到一个response（不是Error），不用保证值是最新的。描述系统对外的状态。
- P：Partion Tolerance，分区容忍，指的是即使出现消息丢失（Network Partion）系统可以正常运行。描述系统内部出现的情况。

# 推导
在分布式系统中网络分区一定会出现，那么这时候如果来了一个request：
- 不处理这个request，这时候就是为了一致性而牺牲可用性。
- 处理这个request，这时候就会有可能丧失一致性来获取可用性。


# 高可用
以3台机器S1，S2，S3构成的分布式存储为例：
1. 当3个节点分别存储一个值的时候，是不具有P能力的，因为一旦一个节点掉线，所存储的东西就没了。
2. 提升P能力要靠副本，副本数为1时不具有P能力，副本数大于等于2时副本数越多P能力越强。
3. 但是副本数提升时就有一致性与可用性的取舍：
   - 选择一致性：所有副本都要同时更新，但是有的节点联系不上，那么这时候系统对外表现无法处理请求
   - 选择可用性：副本就不可能保持一致
4. 所以就要有个取舍：P在分布式系统中一定会出现的，选择就是CP系统还是AP系统，但是后来人们发现C与A不是水火不容的，因为有效副本数量在`[n/2+1, n]`的区间时可以实现一致性，那就可以选择需要有效副本数量最小的`n/2+1`来作为副本数，此时A的能力是最大的，因此这种系统又叫做高可用系统。（有效：可以联系上）

# 例子
## CP系统
有MySQL主备库，主库每次操作都需要完全同步到备库才能返回成功，那么就是牺牲了可用性来来得到一致性。

## AP系统
有MySQL主备库，主库每次操作都异步写入备库，这就是牺牲了一致性来换取可用性。

## 近似CAP系统
每个操作都写入`n/2+1`个副本后就返回成功，此时可用性最佳，一致性也可以保证。


# 区块链引申
区块链需要解决的问题比共识协议更复杂一点，区块链需要解决的是“拜占庭问题”，即有内奸的情况下如何达成共识，通解是当内奸数目大于或等于`n/3`的时候就无解。
