# WindowFunction
## SparkSQL中Window语法
参考链接：[SparkSQL中Window语法](https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-window.html)

<img width="918" alt="image" src="https://github.com/user-attachments/assets/97d0f49b-0958-433e-b6bc-dbba92d89646">
<img width="971" alt="image" src="https://github.com/user-attachments/assets/66c1a242-9fcd-418d-9312-e799a9155d2b">

## window_frame中RANGE VS ROWS对比
```
id	period	shop	revenue
1	2021/04	Shop 2	341,227.53
2	2021/05	Shop 2	315,447.24
3	2021/06	Shop 1	1,845,662.35
4	2021/04	Shop 2	21,487.63
5	2021/05	Shop 1	1,489,774.16
6	2021/06	Shop 1	52,489.35
7	2021/04	Shop 1	154,552.82
8	2021/05	Shop 2	6,548.49
9	2021/06	Shop 2	387,779.49
```

### ROWS参数结果
#### 例子1
```
SELECT
  period,
  shop,
  revenue,
  SUM(revenue) OVER(
    PARTITION BY shop
    ORDER BY period ASC
    ROWS UNBOUNDED PRECEDING
  ) AS rows_cumulative_revenue
FROM revenue_consolidation;
```

![rows-ezgif com-optimize (1)](https://github.com/user-attachments/assets/648dfde0-4a01-4ee4-bcf7-d8cd464b19a8)

#### 例子2
```
ROWS BETWEEEN 2 PRECEDING AND 2 FOLLOWING
```

```
row_index    partition_col        order_by_col        frame_start         frame_end
     0            1                     1                   0                 2
     1            1                     2                   0                 3
     2            1                     2                   0                 4
     3            1                     3                   1                 5
     4            1                     4                   2                 6
     5            1                     4                   3                 7
     6            1                     4                   4                 7
     7            1                     5                   5                 7
```

### RANGE参数结果
#### 例子1
```
SELECT
  period,
  shop,
  revenue,
  SUM(revenue) OVER(
    PARTITION BY shop
    ORDER BY period ASC
    RANGE UNBOUNDED PRECEDING
  ) AS range_cumulative_revenue
FROM revenue_consolidation;
```
![range-ezgif com-optimize](https://github.com/user-attachments/assets/c4499042-846b-443e-b6e1-8f9c6102d694)


#### 例子2
```
RANGE BETWEEEN 2 PRECEDING AND 2 FOLLOWING
```

```
row_index    partition_col        order_by_col        frame_start         frame_end
     0            1                     1                   0                 3
     1            1                     2                   0                 6
     2            1                     2                   0                 6
     3            1                     3                   0                 7
     4            1                     4                   1                 7
     5            1                     4                   1                 7
     6            1                     4                   1                 7
     7            1                     5                   3                 7
```

## ROWS模式和RANGE模式解释
ROWS mode

ROWS mode can be interpreted as indices of the rows in the order in which they appear in the window partition. This ordering is determined by the ORDER BY clause. In ROWS mode, CURRENT ROW refers to the present row at which the function is being evaluated. Each consecutive row has increasing frame number. The frame numbers start at 0 and increase by 1 for each row.

RANGE mode

In RANGE mode, all peer rows have the same frame number. Rows are peers if they have the same values for the ORDER BY field. A frame start of CURRENT ROW refers to the first peer row of the current row, while a frame end of CURRENT ROW refers to the last peer row of the current row. If no ORDER BY is specified, all rows are considered peers of the current row.
